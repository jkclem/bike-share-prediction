---
title: "Analysis"
author: "John Clements and Jingjing Li"
date: "7/1/2021"
output: html_document
  toc: TRUE
#params:  weekday
---

# Introduction  

```{r message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(cowplot)
library(caret)
library(rmarkdown)
```

# Reading in and Subsetting the Data

Before doing any analysis, we need to read in the daily bike-share data and subset for the day of interest.

```{r, message=FALSE}
# Read in the daily data set.
bikeDay <- read_csv("./Bike-Sharing-Dataset/day.csv")
bikeDay <- filter(bikeDay, weekday == 0)
```

Some of the variables, namely, `season`, `mnth`, `holiday`, `workingday`, and `weathersit` are categorical, but are stored numerically. Before proceeding with
the analysis, we are converting them to `factor` data types.

```{r}
# Convert categorical variables stored numerically to factors.
bikeDay <- bikeDay %>%
  mutate(season = factor(ifelse(season == 1, "Spring",     
                                ifelse(season == 2, "Summer", 
                                       ifelse(season == 3, "Fall",
                                              "Winter"))),
                         levels=c("Spring", "Summer", "Fall", "Winter")),
         mnth = factor(mnth, levels=1:12),
         holiday = factor(holiday, levels=c(0, 1)),
         workingday = factor(workingday, levels=c(0, 1)),
         weathersit = ordered(weathersit, levels=c(1, 2, 3, 4))
         )
```

With that done, we can split the two data sets into training and testing sets for predictive modeling.

```{r}
# Set a random seed for reproducibility.
set.seed(10)

# Set the proportion of observations to use for training models.
trainProp <- 0.7

# Get indexes for the training and testing subsets of the daily data.
trainIndexes <- sample(1:nrow(bikeDay),
                          size=nrow(bikeDay)*trainProp)
testIndexes <- setdiff(1:nrow(bikeDay), trainIndexes)
# Use the indexes to separate the training and testing sets of the daily data.
bikeTrain <- bikeDay[trainIndexes, ]
bikeTest <- bikeDay[testIndexes, ]
```

With our data sets created, we can now begin exploring the data.

# Data Exploration

Let's begin our exploration with a histogram of the number of bike rentals in a day for our given day of the week.

```{r echo=FALSE}
# Create a histogram of bike rentals in a day.
plot1 <- ggplot(bikeTrain, aes(x=cnt)) + 
  geom_histogram(bins=25, color="blue", fill="lightblue") + 
  xlab("Bike Rentals") + 
  ylab("Counts") + 
  ggtitle("Histogram of Bike Rentals")

plot1
```

Next, let's examine the numeric variables related to weather: temperature, humidity, and wind speed. Below are the means and standard deviations for each of these variables by season.

```{r echo=FALSE}
# Find the means and standard deviations of temperature, humidity and windspeed
# by season.
seasonalSummary <- bikeTrain %>% 
  group_by(season) %>% 
  summarise(
    avgtemp = mean(temp*41), sdtemp = sd(temp*41), 
    avghum = mean(hum*100), sdhum = sd(hum*100), 
    avgwindspd = mean(windspeed*67), sdwindspd=sd(windspeed*67)
    )
```

```{r echo=FALSE}
knitr::kable(
  seasonalSummary,
  col.names=c("Season", 
              "Temp. Mean", "Temp. Std. Dev.",
              "Humidity Mean", "Humidity Std. Dev.",
              "Wind Speed Mean", "Wind Speed Std. Dev."),
  digits=2,
  caption=paste0("Table 1: Means and Standard Deviations for Daily Temp. ",
                 "(Celsius), Humidity, and Wind Speed (km/h)")
)
```

The boxplots below conveys much of the same information graphically.

```{r echo=FALSE}
###
# Create boxplots of the variables mentioned above, grouped by season.
###
bikeTrain$season <- as.factor(bikeTrain$season)
plot1 <- ggplot(bikeTrain, aes(x=season, y=temp*41, color=season)) + 
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  labs(x="Season",
       y="Temp. (Celsius)",
       title="Box Plot of Temp. by Season") + 
  theme(legend.position="none")

plot2 <- ggplot(bikeTrain, aes(x=season, y=hum*100, color=season)) + 
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  labs(x="Season",
       y="Humidity",
       title="Box Plot of Humidity by Season") + 
  theme(legend.position="none")

plot3 <- ggplot(bikeTrain, aes(x=season, y=windspeed*67, 
                                        color=season)) + 
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  labs(x="Season",
       y="Wind Speed (km/h)",
       title="Box Plot of Wind Speed by Season") + 
  theme(legend.position="none")

plot_grid(plot1, plot2, plot3)
```


```{r echo=FALSE}
# Compare weather situation counts for the four seasons.
seasonWeather <- table(bikeTrain$season, bikeTrain$weathersit)

knitr::kable(
  seasonWeather,
  col.names=c("Pleasant", "Overcast", "Unpleasant", "Severe"),
  caption="Table 3: Weather Situation by Season"
)
```



```{r}
plot4 <- ggplot(bikeTrain, aes(x=temp*41, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Temp. (Celsius)") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Temp.")

#Effect of temperature on total bike renter number
plot5 <- ggplot(bikeTrain, aes(x=hum*100, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Humidity") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Humidity")

#Effect of windspeed on total bike renter number
plot6 <- ggplot(bikeTrain, aes(x=windspeed*67, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Wind Speed (km/h)") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Wind Speed")

#Effect of season on total bike renter number
plot7 <- ggplot(bikeTrain, aes(x=season, y=cnt, color=season)) + 
  geom_boxplot() + 
  geom_jitter(alpha=0.5) + 
  xlab("Season") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Season") +
  theme(legend.position="none")

plot_grid(plot4, plot5, plot6, plot7, ncol=2)
```

```{r}
plot8 <- ggplot(bikeTrain, aes(x=weathersit, y=cnt, 
                                        color=weathersit)) + 
  geom_boxplot() + 
  geom_jitter(alpha=0.5) + 
  xlab("Weather Situation") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Weather") +
  theme(legend.position="none")

plot9 <- ggplot(bikeTrain, aes(x=holiday, y=cnt, color=holiday)) + 
  geom_boxplot() + 
  geom_jitter(alpha=0.5) + 
  xlab("Holiday") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Holiday") +
  theme(legend.position="none")

plot10 <- ggplot(bikeTrain, aes(x=workingday, y=cnt, 
                                        color=workingday)) + 
  geom_boxplot() + 
  geom_jitter(alpha=0.5) + 
  xlab("Working Day") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Working Day") +
  theme(legend.position="none")

plot_grid(plot8, plot9, plot10, ncol=2)

plot11 <- ggplot(bikeTrain, aes(x=windspeed*67, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Wind Speed (km/h)") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Wind Speed")
plot12 <- ggplot(bikeTrain, aes(x=season, y=cnt, color=season)) + 
  geom_boxplot() + 
  geom_jitter(alpha=0.5) + 
  xlab("Season") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Season") +
  theme(legend.position="none")
plot_grid(plot9, plot10, plot11, plot12)

```
Finally, let's compare bike rental counts between our two years of data.

```{r echo=FALSE}
###
# Create a box plot of bike rentals by year.
###
plot13 <- ggplot(bikeTrain, aes(as.factor(yr+2011), cnt,
                                color=as.factor(yr+2011))) + 
  geom_boxplot() + 
  geom_jitter(alpha=0.5) +
  xlab("Year") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Year") +
  theme(legend.position="none")
plot13
```

# Modeling

## Linear model 
$\text{bike rentals}_i = \beta_0 + \beta_1\text{temp} + \beta_2\text{temp}^2 + \beta_3\text{wind speed} + \beta_4\text{wind speed}^2 + \beta_5\text{humidity} + \beta_6\text{humidity}^2 + \beta_7\text{Summer} +\beta_8\text{Fall} + \beta_9\text{Winter} + \beta_{10}\text{year} + \epsilon_i$

```{r}
# Create a trainControl object for repeated k-folds CV.
trCntrl <- trainControl(method="repeatedcv", number=5, repeats=5)
# Evaluate a linear model of the specified form in repeated k-folds CV and fit
# it to the training set.
linMod1 <- train(
  cnt ~ temp + I(temp^2) + windspeed + I(windspeed^2) + hum + I(hum^2) 
  + season + yr,
  data=bikeTrain,
  method="lm",
  trControl=trCntrl
  )
linMod1
```
### 2 


# Create a trainControl object for cross-validation.
trCntrl2 <- trainControl(method="repeatedcv", number=5, repeats=5)
# Evaluate a linear model of the specified form in repeated k-folds CV and fit
# it to the training set.
linMod2 <- train(
  casual ~ temp + I(temp^2) + windspeed + I(windspeed^2) + hum + I(hum^2) 
  + season + yr,
  data=bikeTrain,
  method="glm",
  family="poisson",
  trControl=trCntrl2
  )
linMod2


## Ensemble tree model

Boosting is a way to slowly train a tree. Each tree is created based on previous one. As a result, the variance is aimed to decrease.  

### boosted tree 
{r, echo=T, results='hide'}
#set seed for reproduciblity.
set.seed(50)

#set tuning parameters. 
gbmGrid <- expand.grid(interaction.depth=4, n.trees = 1000,
                   shrinkage=0.1,
                   n.minobsinnode=10)
gbmFit <- train (casual ~., data=select(bikeTrain, -"weekday"),
                   method="gbm",
                   preProcess= c("center", "scale"),
                   trControl = trainControl(method = "cv",
                                            number=10),
                    tuneGrid=gbmGrid)
gbmFit 


# Comparison  

```
#Predict on test data using selected  linear regression model
lmPred2 <- predict(linMod2,  newdata=bikeTest)

#Get RMSE, Rsquared and MAE from predicted models for comparison
lmTest2 <- postResample(lmPred2 , bikeTest$casual)
lmTest2 

#Predict on test data using optimized boosted tree model
boostPred <- predict (gbmFit, newdata=bikeTest )

#Get RMSE, Rsquared and MAE from predicted models for comparison
boostTest <- postResample (boostPred, bikeTest$casual)
boostTest

```


