---
title: "Analysis"
author: "John Clements and Jingjing Li"
date: "7/1/2021"
output: html_document
  toc: TRUE
#params:  weekday
---

# Introduction  

```{r message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(cowplot)
library(caret)
library(rmarkdown)
```

# Reading in and Subsetting the Data

Before doing any analysis, we need to read in the daily and hourly bike-share data and subset for the day of interest.

```{r, message=FALSE}
# Read in the daily and hourly data sets.
bikeDay <- read_csv("../Bike-Sharing-Dataset/day.csv")
bikeHour <- read_csv("../Bike-Sharing-Dataset/hour.csv")

# Filter for the day of interest.
bikeDaySubset <- filter(bikeDay,  weekday == 1)
bikeHourSubset <- filter(bikeHour,  weekday == 1)
```

Some of the variables, namely, `season`, `mnth`, `holiday`, `workingday`, and `weathersit` are categorical, but are stored numerically. Before proceeding with
the analysis, we are converting them to `factor` data types.

```{r}
# Convert categorical variables stored numerically to factors.
bikeDaySubset <- bikeDaySubset %>%
  mutate(season = factor(ifelse(season == 1, "Spring",     
                                ifelse(season == 2, "Summer", 
                                       ifelse(season == 3, "Fall",
                                              "Winter"))),
                         levels=c("Spring", "Summer", "Fall", "Winter")),
         mnth = factor(mnth, levels=1:12),
         holiday = factor(holiday, levels=c(0, 1)),
         workingday = factor(workingday, levels=c(0, 1)),
         weathersit = ordered(weathersit, levels=c(1, 2, 3, 4))
         )
# Convert categorical variables stored numerically to factors.
bikeHourSubset <- bikeHourSubset %>%
  mutate(season = factor(ifelse(season == 1, "Spring",     
                                ifelse(season == 2, "Summer", 
                                       ifelse(season == 3, "Fall",
                                              "Winter"))),
                         levels=c("Spring", "Summer", "Fall", "Winter")),
         mnth = factor(mnth, levels=1:12),
         holiday = factor(holiday, levels=c(0, 1)),
         workingday = factor(workingday, levels=c(0, 1)),
         weathersit = ordered(weathersit, levels=c(1, 2, 3, 4))
         )
```

With that done, we can split the two data sets into training and testing sets for predictive modeling.

```{r}
# Set a random seed for reproducibility.
set.seed(10)

# Set the proportion of observations to use for training models.
trainProp <- 0.7

# Get indexes for the training and testing subsets of the daily data.
trainDaySubset <- sample(1:nrow(bikeDaySubset),
                          size=nrow(bikeDaySubset)*trainProp)
testDaySubset <- setdiff(1:nrow(bikeDaySubset), trainDaySubset)
# Use the indexes to separate the training and testing sets of the daily data.
bikeDayTrainSubset <- bikeDaySubset[trainDaySubset, ]
bikeDayTestSubset <- bikeDaySubset[testDaySubset, ]

# Get indexes for the training and testing subsets of the hourly data.
trainHourSubset <- sample(1:nrow(bikeHourSubset),
                           size=nrow(bikeHourSubset)*trainProp)
testHourSubset <- setdiff(1:nrow(bikeHourSubset), trainHourSubset)
# Use the indexes to separate the training and testing sets of the hourly data.
bikeHourTrainSubset <- bikeHourSubset[trainHourSubset, ]
bikeHourTestSubset <- bikeHourSubset[testHourSubset, ]
```

With our data sets created, we can now begin exploring the data.

# Data Exploration

Let's begin our exploration with the numeric variables related to weather: temperature, humidity, and wind speed. Below are the means and standard deviations for each of these variables by season.

```{r echo=FALSE}
# Find the means and standard deviations of temperature, humidity and windspeed
# by season.
seasonalSummary <- bikeDayTrainSubset %>% 
  group_by(season) %>% 
  summarise(
    avgtemp = mean(temp*41), sdtemp = sd(temp*41), 
    avghum = mean(hum*100), sdhum = sd(hum*100), 
    avgwindspd = mean(windspeed*67), sdwindspd=sd(windspeed*67)
    )
```

```{r echo=FALSE}
knitr::kable(
  seasonalSummary,
  col.names=c("Season", 
              "Temp. Mean", "Temp. Std. Dev.",
              "Humidity Mean", "Humidity Std. Dev.",
              "Wind Speed Mean", "Wind Speed Std. Dev."),
  digits=2,
  caption=paste0("Table 1: Means and Standard Deviations for Daily Temp. ",
                 "(Celsius), Humidity, and Wind Speed (km/h)")
)
```

The boxplots below conveys much of the same information graphically.

```{r echo=FALSE}
###
# Create boxplots of the variables mentioned above, grouped by season.
###

plot1 <- ggplot(bikeDayTrainSubset, aes(x=season, y=temp*41, color=season)) + 
  geom_boxplot() +
  geom_jitter() +
  labs(x="Season",
       y="Temp. (Celsius)",
       title="Box Plot of Temp. by Season") + 
  theme(legend.position="none")

plot2 <- ggplot(bikeDayTrainSubset, aes(x=season, y=hum*100, color=season)) + 
  geom_boxplot() +
  geom_jitter() +
  labs(x="Season",
       y="Humidity",
       title="Box Plot of Humidity by Season") + 
  theme(legend.position="none")

plot3 <- ggplot(bikeDayTrainSubset, aes(x=season, y=windspeed*67, 
                                        color=season)) + 
  geom_boxplot() +
  geom_jitter() +
  labs(x="Season",
       y="Wind Speed (km/h)",
       title="Box Plot of Wind Speed by Season") + 
  theme(legend.position="none")

plot_grid(plot1, plot2, plot3)
```


```{r echo=FALSE}
# Compare weather situation counts for the two years.
yearWeather <- table(bikeDayTrainSubset$yr, bikeDayTrainSubset$weathersit)
row.names(yearWeather) <- c("2011", "2012")

# Compare weather situation counts for the four seasons.
seasonWeather <- table(bikeDayTrainSubset$season, bikeDayTrainSubset$weathersit)
```

```{r echo=FALSE}
knitr::kable(
  yearWeather,
  col.names=c("Pleasant", "Overcast", "Unpleasant", "Severe"),
  caption="Table 2: Weather Situation by Year"
)
```

```{r echo=FALSE}
knitr::kable(
  seasonWeather,
  col.names=c("Pleasant", "Overcast", "Unpleasant", "Severe"),
  caption="Table 3: Weather Situation by Season"
)
```

```{r}
#observe on distribution of total bike renter counts
plot4<- ggplot(bikeDayTrainSubset, aes(x=cnt)) + 
  geom_histogram() + 
  xlab("total bike renter number") + 
  ggtitle("Distribution of total bike renter counts")
```

```{r}
plot4 <- ggplot(bikeDayTrainSubset, aes(x=temp*41, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Temp. (Celsius)") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Temp.")

#Effect of temperature on total bike renter number
plot5 <- ggplot(bikeDayTrainSubset, aes(x=hum*100, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Humidity") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Humidity")

#Effect of windspeed on total bike renter number
plot6 <- ggplot(bikeDayTrainSubset, aes(x=windspeed*67, y=cnt)) + 
  geom_point(color="blue", alpha=0.5) + 
  geom_smooth(method = 'lm', formula='y ~ poly(x, 2)', color="red") +
  xlab("Wind Speed (km/h)") + 
  ylab("Rentals") + 
  ggtitle("Bike Rentals vs. Wind Speed")

#Effect of season on total bike renter number
plot7 <- ggplot(bikeDayTrainSubset, aes(x=season, y=cnt, color=season)) + 
  geom_boxplot() + 
  geom_jitter() + 
  xlab("Season") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Season") +
  theme(legend.position="none")

plot_grid(plot4, plot5, plot6, plot7, ncol=2)
```

```{r}
plot8 <- ggplot(bikeDayTrainSubset, aes(x=weathersit, y=cnt, 
                                        color=weathersit)) + 
  geom_boxplot() + 
  geom_jitter() + 
  xlab("Weather Situation") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Weather") +
  theme(legend.position="none")

plot9 <- ggplot(bikeDayTrainSubset, aes(x=holiday, y=cnt, color=holiday)) + 
  geom_boxplot() + 
  geom_jitter() + 
  xlab("Holiday") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Holiday") +
  theme(legend.position="none")

plot10 <- ggplot(bikeDayTrainSubset, aes(x=workingday, y=cnt, 
                                        color=workingday)) + 
  geom_boxplot() + 
  geom_jitter() + 
  xlab("Working Day") + 
  ylab("Bike Rentals") + 
  ggtitle("Bike Rentals by Working Day") +
  theme(legend.position="none")

plot_grid(plot8, plot9, plot10, ncol=2)
```


# Modeling

## Linear model 

### 2 


```{r}
bikeDayTrainSubset$season <- as.numeric(bikeDayTrainSubset$season)
pairs(bikeDayTrainSubset )
lmfit1a <- lm(casual~temp, data=bikeDayTrainSubset)
summary(lmfit1a)

lmfit1b <- lm(casual~ mnth, data=bikeDayTrainSubset)
summary(lmfit1b) 

lmfit1c <- lm(casual~ windspeed , data=bikeDayTrainSubset)
summary(lmfit1c) 

lmfit1d <- lm(casual~season , data=bikeDayTrainSubset)
summary(lmfit1d) 

lmfit2a <- lm(casual~temp*season, data=bikeDayTrainSubset)
summary(lmfit2a)

lmfit2b <- lm(casual~temp*windspeed, data=bikeDayTrainSubset)
summary(lmfit2b)

lmfit2c <- lm(casual~season*windspeed, data=bikeDayTrainSubset)
summary(lmfit2c)

lmfit3a <- lm(casual~ temp + I(temp^2), data=bikeDayTrainSubset)
summary(lmfit3a) 

lmfit3b <- lm(casual~ windspeed + I(windspeed ^2), data=bikeDayTrainSubset)
summary(lmfit3b)
lmfit3c <- lm(casual~ season + I(season^2), data=bikeDayTrainSubset)
summary(lmfit3c) 

lmfit4a <- lm(casual~temp*windspeed, data=bikeDayTrainSubset)
summary(lmfit4a)

lmfit4b <- lm(casual~temp*season, data=bikeDayTrainSubset)
summary(lmfit4b)

lmfit5a <- lm(casual~temp*windspeed*season, data=bikeDayTrainSubset)
summary(lmfit5a)

lmfit5b <- lm(casual~temp*windspeed*season + I(temp^2)+ I(windspeed^2)+ I(season^2), data=bikeDayTrainSubset)
summary(lmfit5b)

trainFit <- function (fit) {
  model <- round(c(summary(fit)$adj.r.squared, AIC(fit), 
                   MuMIn::AICc(fit), BIC(fit)), 3)
  name <- c("adj.r.sqr", "AIC","AICc", "BIC")
  df_stat <- data.frame(name, model)
  df_stat2 <- spread(df_stat, name, model)
}
stat1a <- trainFit(lmfit1a)
stat1b <- trainFit(lmfit1b)
stat1c <- trainFit(lmfit1c)
stat1d <- trainFit(lmfit1c)
  
stat2a <- trainFit(lmfit2a)
stat2b <- trainFit(lmfit2b)
stat2c <- trainFit(lmfit2c)

stat3a <- trainFit(lmfit3a)
stat3b <- trainFit(lmfit3b)
stat3c <- trainFit(lmfit3c)
    
stat4a <- trainFit(lmfit4a)        
stat4b <- trainFit(lmfit4b) 

stat5a<- trainFit(lmfit5a)
stat5b<- trainFit(lmfit5a)

stat_sum <- rbind(stat1a,stat1b,stat1c,stat1d,stat2a,stat2b,stat2c,stat3a,stat3b,stat3c,stat4a,stat4b,stat5a,stat5b)
rownames (stat_sum) <-c("lmfit1a","lmfit1b","lmfit1c","lmfit1d","lmfit2a","lmfit2b","lmfit2c", "lmfit3a","lmfit3b","lmfit3c","lmfit4a","lmfit4b","lmfit5a","lmfit5b") 
stat_sum 
```

## Ensemble tree model

Boosting is a way to slowly train a tree. 

### boosted tree 
```{r}
set.seed(50)
gbmGrid <- expand.grid(interaction.depth=4, n.trees = 1000,
                   shrinkage=0.1,
                   n.minobsinnode=10)
gbmFit <- train (casual ~., data=select(bikeDayTrainSubset, -"weekday"),
                   method="gbm",
                   preProcess= c("center", "scale"),
                   trControl = trainControl(method = "cv",
                                            number=10),
                    tuneGrid=gbmGrid)
gbmFit 
```

# Comparison  

```{r}
lmPred <- predict(lmfit1a,  newdata=bikeDayTestSubset)
lmTest <- postResample(lmPred , bikeDayTestSubset$casual)
lmTest 
boostPred <- predict (gbmFit, newdata=select (bikeDayTestSubset, - casual ), n.trees=1000)
boostTest <- postResample(boostPred, bikeDayTestSubset$casual)
boostTest

```

# Automation

```{r}
weekday <- unique(bikeday$weekday)
output_file <- paste0( weekday, ".html")
params=lapply(weekday, FUN=function(x){list(weekday=x)})
reports <- tibble(output_file, params)
reports
apply(reports, MARGIN=1, 
    FUN=function(x){
                    render(input="../bike-share-prediction/Analysis.Rmd",
                           output_file=x[[1]],params=x[[2]])
    })
```

